#!/bin/bash

#
# Run code embeded into MarkDown documents
#

# $1 is a MarkDown document
typeset -r PROGRAM=${1?Expected program filename}
shift

# Extract code
typeset -r CODE=/tmp/${PROGRAM%.md}
typeset -i onblock=0
typeset line

IFS=''
while read -r line; do
    if [[ $line == '```'* ]]; then
        if (( onblock )); then
            onblock=0
        else
            onblock=1
        fi
        echo
    else
        if (( onblock )); then
            echo "$line"
        else
            echo
        fi
    fi
done < "$PROGRAM" > "$CODE"


RUN=">>> Running $PROGRAM (temporary files left at /tmp:"

case "$PROGRAM" in
    *.sh.md)
        echo 1>&2 "$RUN ${PROGRAM%.md})"
        exec bash "$CODE" "$@"
        ;;
    *.py.md)
        echo 1>&2 "$RUN ${PROGRAM%.md})"
        exec python "$CODE" "$@"
        ;;
    *.c.md|*.cpp.md)
        echo 1>&2 "$RUN ${PROGRAM%.md} and a.out)"
        gcc "$CODE" -o /tmp/a.out && exec /tmp/a.out "$@"
        ;;
    *.java.md)
        echo 1>&2 "$RUN ${PROGRAM%.md} and ${PROGRAM%.java.md}.class)"
        javac -d /tmp "$CODE" && cd /tmp && java "${PROGRAM%.java.md}" "$@"
        ;;
    *)
        exec cat "$CODE"
        ;;
esac

exit    # never reached

# vim:ai:et:sw=4:ts=4:syntax=sh
